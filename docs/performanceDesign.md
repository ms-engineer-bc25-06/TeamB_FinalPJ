# 性能設計書

## 目的

本ドキュメントは、感情教育アプリ『きもちみっけ！』の性能設計について定義する。ユーザー体験の向上とシステムの安定性を確保するため、適切な性能要件と対策を実装する。

## このドキュメントの使い方

性能要件や最適化方針を確認したい時に参照してください。パフォーマンス改善や負荷テストの設計に使用します。

## 1. 概要

### 1.2 対象システム
- フロントエンド: Next.js (TypeScript)
- バックエンド: FastAPI (Python)
- データベース: PostgreSQL
- ストレージ: AWS S3
- 音声処理: OpenAI Whisper

---

## 2. S3連携の性能設計

### 2.1 直接アップロード方式

#### 2.1.1 概要
- **方式**: Presigned URLを使用したS3直接アップロード
- **フロー**: フロントエンド → S3（サーバーを経由しない）
- **性能効果**: 
  - サーバーの負荷軽減
  - アップロード速度の向上
  - スケーラビリティの向上

#### 2.1.2 性能比較

| 方式 | フロー | サーバー負荷 | アップロード速度 | スケーラビリティ |
|------|--------|--------------|------------------|------------------|
| 従来方式 | フロントエンド → サーバー → S3 | 高（ファイル転送） | 中（2段階転送） | 低（サーバー容量依存） |
| 直接アップロード | フロントエンド → S3 | 低（URL生成のみ） | 高（直接転送） | 高（S3容量依存） |

### 2.2 ファイルサイズ最適化

#### 2.2.1 音声ファイル圧縮
- **形式**: WebM（VP8/VP9）、WAV、MP3
- **最適化**: 
  - 16kHz/モノラル/16bitに変換
  - ファイルサイズを約70%削減
  - アップロード時間の短縮

#### 2.2.2 ファイルサイズ制限
- **制限**: 最大10MB
- **効果**: 
  - アップロード時間の予測可能化
  - ストレージコストの制御
  - システム負荷の安定化

### 2.3 並行処理の最適化

#### 2.3.1 非同期処理
- **実装**: FastAPIの非同期機能
- **効果**: 
  - 複数リクエストの同時処理
  - レスポンス時間の短縮
  - リソース効率の向上

#### 2.3.2 音声処理の並行化
- **実装**: Whisper処理の非同期実行
- **効果**: 
  - ユーザー待機時間の短縮
  - システム全体のスループット向上

---

## 3. データベース性能設計

### 3.1 インデックス設計

#### 3.1.1 主要インデックス
- **users.uid**: Firebase UIDによる高速検索
- **emotion_logs.user_id, created_at**: ユーザー別日次検索
- **emotion_logs.child_id, created_at**: 子ども別日次検索

#### 3.1.2 複合インデックス
- **emotion_logs(user_id, child_id, created_at)**: 複数条件での高速検索
- **weekly_reports(user_id, child_id, week_start_date)**: 週次レポート検索

### 3.2 クエリ最適化

#### 3.2.1 効率的なクエリ設計
- **JOIN最小化**: 必要なテーブルのみ結合
- **LIMIT使用**: 大量データ取得時の制限
- **適切なWHERE句**: インデックスを活用する条件

#### 3.2.2 ページネーション
- **実装**: カーソルベースページネーション
- **効果**: 
  - メモリ使用量の削減
  - レスポンス時間の安定化

---

## 4. キャッシュ戦略

### 4.1 アプリケーションレベルキャッシュ

#### 4.1.1 感情カードマスタ
- **対象**: emotion_cards, intensity
- **方式**: アプリケーション起動時にメモリに読み込み
- **効果**: 
  - データベースアクセス削減
  - レスポンス時間短縮

#### 4.1.2 ユーザー情報キャッシュ
- **対象**: 認証済みユーザー情報
- **方式**: セッション期間中キャッシュ
- **効果**: 
  - 認証処理の高速化
  - データベース負荷軽減

### 4.2 CDN活用

#### 4.2.1 静的ファイル配信
- **対象**: 感情カード画像、音声ファイル
- **方式**: CloudFront等のCDN使用
- **効果**: 
  - 配信速度向上
  - サーバー負荷軽減

---

## 5. 監視・メトリクス

### 5.1 性能指標

#### 5.1.1 レスポンス時間
- **目標**: API レスポンス < 500ms
- **監視**: 各エンドポイントの平均・95パーセンタイル

#### 5.1.2 スループット
- **目標**: 同時接続数 100以上
- **監視**: リクエスト/秒、エラー率

#### 5.1.3 リソース使用率
- **目標**: CPU < 70%, メモリ < 80%
- **監視**: サーバー、データベース、S3使用量

### 5.2 アラート設定

#### 5.2.1 性能アラート
- **レスポンス時間**: 1秒超過
- **エラー率**: 5%超過
- **リソース使用率**: 80%超過

---

## 6. スケーラビリティ設計

### 6.1 水平スケーリング

#### 6.1.1 アプリケーションサーバー
- **方式**: 複数インスタンスでの負荷分散
- **効果**: 
  - 同時接続数の増加対応
  - 可用性の向上

#### 6.1.2 データベース
- **方式**: 読み取り専用レプリカ
- **効果**: 
  - 読み取り負荷の分散
  - レスポンス時間の改善

### 6.2 垂直スケーリング

#### 6.2.1 リソース増強
- **CPU**: 必要に応じて増強
- **メモリ**: キャッシュ効果向上のため増強
- **ストレージ**: S3の自動スケーリング活用

---

## 7. 性能テスト

### 7.1 負荷テスト

#### 7.1.1 テストシナリオ
- **同時ユーザー**: 100ユーザー
- **テスト時間**: 30分
- **測定項目**: レスポンス時間、エラー率、スループット

#### 7.1.2 テストツール
- **Locust**: Python製負荷テストツール
- **JMeter**: Java製負荷テストツール

### 7.2 性能ボトルネック特定

#### 7.2.1 プロファイリング
- **cProfile**: Pythonコードの性能分析
- **pg_stat_statements**: PostgreSQLクエリ分析

---

## 8. 最適化の実装優先度

### 8.1 高優先度
- [ ] **インデックス最適化** - データベースクエリの高速化
- [ ] **ファイルサイズ制限** - アップロード時間の制御
- [ ] **キャッシュ実装** - レスポンス時間の短縮

### 8.2 中優先度
- [ ] **CDN導入** - 静的ファイル配信の高速化
- [ ] **監視システム構築** - 性能指標の可視化

### 8.3 低優先度
- [ ] **水平スケーリング** - 大規模化対応
- [ ] **高度なキャッシュ戦略** - Redis等の導入
