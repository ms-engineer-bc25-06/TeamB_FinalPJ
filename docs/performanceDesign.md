# 性能設計書

## 目的

本ドキュメントは、感情教育アプリ『きもちみっけ！』の性能設計について定義する。ユーザー体験の向上とシステムの安定性を確保するため、適切な性能要件と対策を実装する。
すでに実装しているものには（実装済み）と記載。

## このドキュメントの使い方

性能要件や最適化方針を確認したい時に参照してください。パフォーマンス改善や負荷テストの設計に使用します。

## 1. 概要

### 1.1 対象システム
- フロントエンド: Next.js  (TypeScript)
- バックエンド: FastAPI  (Python )
- データベース: PostgreSQL 
- ストレージ: AWS S3
- 音声処理: OpenAI Whisper (baseモデル)

### 1.2 性能要件

#### 1.2.1 レスポンス時間要件
- **API レスポンス時間**: < 500ms（95パーセンタイル）
- **音声認識処理**: < 10秒（30秒以内の音声ファイル）
- **ページ読み込み時間**: < 2秒（フロントエンド）
- **データベースクエリ**: < 100ms（単純クエリ）

#### 1.2.2 スループット要件
- **同時接続数**: 100ユーザー以上
- **リクエスト/秒**: 50 RPS以上
- **音声処理**: 10ファイル/分以上
- **データベース接続**: 20接続以上

#### 1.2.3 可用性要件
- **システム稼働率**: 99.5%以上
- **エラー率**: < 1%
- **ダウンタイム**: 月間4時間以内

---

## 2. データベース性能設計

### 2.1 インデックス設計（実装済み）

#### 2.1.1 主要インデックス
```python
# models.py で実装済み
class User(Base):
    uid: Mapped[str] = mapped_column(String, unique=True, nullable=False, index=True)
    email: Mapped[str] = mapped_column(String, unique=True, nullable=False, index=True)

class Subscription(Base):
    user_id: Mapped[uuid.UUID] = mapped_column(UUID(as_uuid=True), ForeignKey("users.id"), nullable=False, unique=True, index=True)

class Child(Base):
    user_id: Mapped[uuid.UUID] = mapped_column(UUID(as_uuid=True), ForeignKey("users.id"), nullable=False, index=True)

class EmotionLog(Base):
    child_id: Mapped[uuid.UUID] = mapped_column(UUID(as_uuid=True), ForeignKey("children.id"), nullable=False, index=True)
```

#### 2.1.2 複合インデックス（推奨）
- **emotion_logs(user_id, child_id, created_at)**: ユーザー別・子ども別の感情ログ検索
- **daily_reports(child_id, created_at)**: 日次レポート検索
- **weekly_reports(user_id, child_id, week_start_date)**: 週次レポート検索

### 2.2 クエリ最適化

#### 2.2.1 効率的なクエリ設計
- **JOIN最小化**: 必要なテーブルのみ結合
- **LIMIT使用**: 大量データ取得時の制限
- **適切なWHERE句**: インデックスを活用する条件

#### 2.2.2 ページネーション
- **実装**: カーソルベースページネーション
- **効果**: 
  - メモリ使用量の削減
  - レスポンス時間の安定化

---

## 3. 音声処理性能設計

### 3.1 Whisper最適化（実装済み）

#### 3.1.1 モデル選択
```python
# whisper.py で実装済み
_DEFAULTS = {
    "model_name": os.getenv("WHISPER_MODEL_SIZE", "base"),  # 速度重視
    "temperature": float(os.getenv("WHISPER_TEMPERATURE", "0.0")),
    "beam_size": int(os.getenv("WHISPER_BEAM_SIZE", "1")),  # 速度重視
    "best_of": int(os.getenv("WHISPER_BEST_OF", "1")),      # 速度重視
}
```

#### 3.1.2 音声最適化（実装済み）
```python
# audio_optimizer.py で実装済み
def optimize_for_whisper(self, input_path: str) -> Optional[str]:
    cmd = [
        'ffmpeg',
        '-i', input_path,
        '-ar', '16000',      # 16kHz
        '-ac', '1',          # モノラル
        '-c:a', 'pcm_s16le', # 16bit PCM
        '-af', 'loudnorm',   # 音量正規化
        '-y', output_path
    ]
```

### 3.2 ファイルサイズ最適化

#### 3.2.1 音声ファイル圧縮
- **形式**: WebM、WAV、MP3
- **最適化**: 
  - 16kHz/モノラル/16bitに変換
  - ファイルサイズを約70%削減
  - アップロード時間の短縮

#### 3.2.2 ファイルサイズ制限
- **制限**: 最大10MB
- **効果**: 
  - アップロード時間の予測可能化
  - ストレージコストの制御
  - システム負荷の安定化

---

## 4. S3連携の性能設計

### 4.1 直接アップロード方式

#### 4.1.1 概要
- **方式**: Presigned URLを使用したS3直接アップロード
- **フロー**: フロントエンド → S3（サーバーを経由しない）
- **性能効果**: 
  - サーバーの負荷軽減
  - アップロード速度の向上
  - スケーラビリティの向上

#### 4.1.2 性能比較

| 方式 | フロー | サーバー負荷 | アップロード速度 | スケーラビリティ |
|------|--------|--------------|------------------|------------------|
| 従来方式 | フロントエンド → サーバー → S3 | 高（ファイル転送） | 中（2段階転送） | 低（サーバー容量依存） |
| 直接アップロード | フロントエンド → S3 | 低（URL生成のみ） | 高（直接転送） | 高（S3容量依存） |

---

## 5. キャッシュ戦略

### 5.1 アプリケーションレベルキャッシュ

#### 5.1.1 感情カードマスタ
- **対象**: emotion_cards, intensity
- **方式**: アプリケーション起動時にメモリに読み込み
- **効果**: 
  - データベースアクセス削減
  - レスポンス時間短縮

#### 5.1.2 ユーザー情報キャッシュ
- **対象**: 認証済みユーザー情報
- **方式**: セッション期間中キャッシュ
- **効果**: 
  - 認証処理の高速化
  - データベース負荷軽減

### 5.2 CDN活用

#### 5.2.1 静的ファイル配信
- **対象**: 感情カード画像、音声ファイル
- **方式**: CloudFront等のCDN使用
- **効果**: 
  - 配信速度向上
  - サーバー負荷軽減

---

## 6. 監視・メトリクス

### 6.1 性能測定の仕組み

#### 6.1.1 ヘルスチェック（実装済み）
```python
# voice.py で実装済み
@router.get("/health", summary="音声APIヘルスチェック", description="音声APIの稼働状態を確認")
async def health_check():
    return {"status": "healthy", "service": "voice-api"}
```

#### 6.1.2 性能指標
- **レスポンス時間**: API レスポンス < 500ms
- **スループット**: 同時接続数 100以上
- **リソース使用率**: CPU < 70%, メモリ < 80%

### 6.2 アラート設定

#### 6.2.1 性能アラート
- **レスポンス時間**: 1秒超過
- **エラー率**: 5%超過
- **リソース使用率**: 80%超過

---

## 7. 負荷テスト設計

### 7.1 テストシナリオ

#### 7.1.1 基本負荷テスト
- **同時ユーザー**: 50ユーザー
- **テスト時間**: 15分
- **測定項目**: レスポンス時間、エラー率、スループット

#### 7.1.2 音声処理負荷テスト
- **同時音声処理**: 10ファイル
- **ファイルサイズ**: 5MB以下
- **測定項目**: 処理時間、成功率、リソース使用率

### 7.2 テストツール

#### 7.2.1 推奨ツール
- **Locust**: Python製負荷テストツール
- **JMeter**: Java製負荷テストツール
- **Artillery**: Node.js製負荷テストツール

#### 7.2.2 テスト環境
- **本番同等環境**: Docker Compose環境
- **データ量**: 本番の10%程度
- **ネットワーク**: ローカル環境

---

## 8. スケーラビリティ設計

### 8.1 水平スケーリング

#### 8.1.1 アプリケーションサーバー
- **方式**: 複数インスタンスでの負荷分散
- **効果**: 
  - 同時接続数の増加対応
  - 可用性の向上

#### 8.1.2 データベース
- **方式**: 読み取り専用レプリカ
- **効果**: 
  - 読み取り負荷の分散
  - レスポンス時間の改善

### 8.2 垂直スケーリング

#### 8.2.1 リソース増強
- **CPU**: 必要に応じて増強
- **メモリ**: キャッシュ効果向上のため増強
- **ストレージ**: S3の自動スケーリング活用

---

## 9. 最適化の実装優先度

### 9.1 高優先度（実装済み）
- [x] **インデックス最適化** - データベースクエリの高速化
- [x] **音声最適化** - Whisper処理の高速化
- [x] **ファイルサイズ制限** - アップロード時間の制御

### 9.2 中優先度（実装予定）
- [ ] **キャッシュ実装** - レスポンス時間の短縮
- [ ] **CDN導入** - 静的ファイル配信の高速化
- [ ] **監視システム構築** - 性能指標の可視化

### 9.3 低優先度（将来実装）
- [ ] **水平スケーリング** - 大規模化対応
- [ ] **高度なキャッシュ戦略** - Redis等の導入
- [ ] **データベース最適化** - クエリチューニング

---

## 10. 性能テスト実施計画

### 10.1 テスト実施スケジュール
- **開発環境**: 週次実施
- **ステージング環境**: リリース前実施
- **本番環境**: 月次実施

### 10.2 テスト結果の評価基準
- **合格基準**: 性能要件を満たす
- **改善基準**: 性能要件の80%以上
- **要改善**: 性能要件の80%未満

### 10.3 継続的改善
- **性能監視**: 24時間監視
- **定期レビュー**: 月次レビュー
- **改善実施**: 四半期ごと