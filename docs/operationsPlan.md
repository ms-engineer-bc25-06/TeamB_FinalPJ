# 運用設計書

## 目的

本ドキュメントは、感情教育アプリ『きもちみっけ！』の運用設計について定義する。システムの安定性、可用性、保守性を確保するため、適切な運用プロセスと監視体制を構築し、運用コストとデプロイフローについて具体的に定義する。予算計画の策定とリリース作業の効率化を図るため、コスト構造とデプロイ手順を明確化する。

## このドキュメントの使い方

システムの安定性・可用性・保守性を確保するための運用プロセスを確認したい時に参照してください。運用コストの確認、予算計画の策定、デプロイ手順の確認、リリース作業に使用します。

## 1. 運用コスト

### 1.1 総運用コスト予測

| 環境 | 月間コスト | 年間コスト | 備考 |
|------|------------|------------|------|
| 開発環境 | ¥3,000-5,000 | ¥36,000-60,000 | ローカル開発中心 |
| ステージング環境 | ¥1,000-3,000 | ¥12,000-36,000 | 本番前テスト用 |
| 本番環境（300人規模） | ¥4,600-15,800 | ¥55,200-189,600 | 本構成 |
| 本番環境（1,000人規模） | ¥10,600-25,600 | ¥127,200-307,200 | スケーラブルに拡張可能 |

### 1.2 コスト内訳（300人規模・本構成）
- **Vercel**: ¥0（無料枠内）
- **Cloud Run**: ¥0（無料枠内）
- **Cloud SQL**: ¥5,000-10,000（本番構成）
- **AWS S3**: ¥800-2,300（音声ファイル）
- **Whisper API**: ¥0（ローカルモデル）
- **Cloud Monitoring**: ¥500-2,000（監視・ログ）
- **その他**: ¥100-500
- **合計**: ¥6,400-15,800/月

### 1.3 主要サービスコスト

#### フロントエンド（Vercel）
- 無料プラン: ¥0/月（個人利用）
- Proプラン: ¥3,000/月（チーム利用推奨）

#### バックエンド（Cloud Run）
- 無料枠: 月200万リクエスト、360,000 vCPU-seconds
- 300人規模でほぼ無料枠内

#### データベース（Cloud SQL）
- 最小構成（db-f1-micro）: ¥1,500/月
- 本番構成: ¥5,000-10,000/月

#### 外部サービス
- **音声認識**: ¥0/月（ローカルWhisper使用）
- **Firebase**: 無料（月10,000認証まで）
- **Stripe**: 2.9% + 30円/取引（月額固定費なし）

## 2. デプロイフロー

### 2.1 環境概要
- **開発環境**: ローカル（Docker Compose）
- **ステージング環境**: Vercel + Cloud Run + Cloud SQL（最小構成）
- **本番環境**: Vercel + Cloud Run + Cloud SQL（本番構成）

### 2.2 デプロイフロー
- **現在の実装**: 手動デプロイ（開発中）
- **将来の予定**: GitHub Actionsによる自動化
- **ステージング**: `develop`ブランチ → ステージング環境（予定）
- **本番**: `main`ブランチ → 本番環境（予定）

### 2.3 選定理由

#### 2.3.1 環境構成の選定理由
- **開発環境（Docker Compose）**: 
  - ローカル開発の高速化
  - 本番環境との一貫性確保
  - チーム開発での環境統一

- **ステージング環境（最小構成）**:
  - 本番前の最終検証
  - コスト最適化（最小構成）
  - 本番環境との差分検証

- **本番環境（本番構成）**:
  - 高可用性・高パフォーマンス
  - 自動スケーリング対応
  - 本番レベルの監視・ログ

#### 2.3.2 デプロイ方式の選定理由
- **現在の手動デプロイ**:
  - 開発段階での柔軟性確保
  - 段階的な自動化導入
  - 学習コストの最小化

- **将来のGitHub Actions自動化**:
  - CI/CDパイプラインの構築
  - テスト・ビルド・デプロイの自動化
  - 人的ミスの削減
  - デプロイ時間の短縮

#### 2.3.3 ブランチ戦略の選定理由
- **developブランチ → ステージング**:
  - 機能統合前の検証
  - 本番前の最終テスト
  - リリース候補の検証

- **mainブランチ → 本番**:
  - 安定版の本番リリース
  - 本番環境の安定性確保
  - ロールバックの容易性
