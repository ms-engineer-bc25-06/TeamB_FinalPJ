# 運用設計書

## 目的

本ドキュメントは、感情教育アプリ『きもちみっけ！』の運用設計について定義する。システムの安定性、可用性、保守性を確保するため、適切な運用プロセスと監視体制を構築し、運用コストとデプロイフローについて具体的に定義する。予算計画の策定とリリース作業の効率化を図るため、コスト構造とデプロイ手順を明確化する。

## このドキュメントの使い方

システムの安定性・可用性・保守性を確保するための運用プロセスを確認したい時に参照してください。運用コストの確認、予算計画の策定、デプロイ手順の確認、リリース作業に使用します。

## 1. 運用コスト

### 1.1 総運用コスト予測

| 環境 | 月間コスト | 年間コスト | 備考 |
|------|------------|------------|------|
| 開発環境 | ¥3,000-5,000 | ¥36,000-60,000 | ローカル開発中心 |
| ステージング環境 | ¥1,000-3,000 | ¥12,000-36,000 | 本番前テスト用 |
| 本番環境（300人規模） | ¥4,600-15,800 | ¥55,200-189,600 | 本構成 |
| 本番環境（1,000人規模） | ¥10,600-25,600 | ¥127,200-307,200 | スケーラブルに拡張可能 |

### 1.2 コスト内訳（300人規模・本構成）
- **Vercel**: ¥0（無料枠内）
- **Cloud Run**: ¥0（無料枠内）
- **Cloud SQL**: ¥5,000-10,000（本番構成）
- **AWS S3**: ¥800-2,300（音声ファイル）
- **Whisper API**: ¥0（ローカルモデル）
- **Cloud Monitoring**: ¥500-2,000（監視・ログ）
- **その他**: ¥100-500
- **合計**: ¥6,400-15,800/月

### 1.3 主要サービスコスト

#### フロントエンド（Vercel）
- 無料プラン: ¥0/月（個人利用）
- Proプラン: ¥3,000/月（チーム利用推奨）

#### バックエンド（Cloud Run）
- 無料枠: 月200万リクエスト、360,000 vCPU-seconds
- 300人規模でほぼ無料枠内

#### データベース（Cloud SQL）
- 最小構成（db-f1-micro）: ¥1,500/月
- 本番構成: ¥5,000-10,000/月

#### 外部サービス
- **音声認識**: ¥0/月（ローカルWhisper使用）
- **Firebase**: 無料（月10,000認証まで）
- **Stripe**: 2.9% + 30円/取引（月額固定費なし）

## 2. デプロイフロー

### 2.1 環境概要
- **開発環境**: ローカル（Docker Compose）
- **ステージング環境**: Vercel + Cloud Run + Cloud SQL（最小構成）
- **本番環境**: Vercel + Cloud Run + Cloud SQL（本番構成）

### 2.2 デプロイフロー
- **現在の実装**: 手動デプロイ（開発中）
- **将来の予定**: GitHub Actionsによる自動化
- **ステージング**: `develop`ブランチ → ステージング環境（予定）
- **本番**: `main`ブランチ → 本番環境（予定）

### 2.3 機能追加・修正時のデプロイフロー

#### 2.3.1 開発からデプロイまでの流れ
1. **フィーチャーブランチ作成**
   ```bash
   git checkout -b feature/機能名
   # または
   git checkout -b fix/修正内容
   ```

2. **ローカル開発・テスト**
   - フロントエンド: `npm run dev` でローカル開発
   - バックエンド: Docker Composeでローカル環境構築
   - 単体テスト実行: `npm test` / `pytest`
   - 手動テスト: ローカル環境での動作確認

3. **コードレビュー**
   - GitHub Pull Request作成
   - チームメンバーによるコードレビュー
   - レビュー指摘事項の修正

4. **developブランチへのマージ**
   - レビュー承認後、developブランチにマージ
   - 自動的にステージング環境にデプロイ（予定）

5. **ステージング環境での検証**
   - 自動テスト実行: GitHub ActionsによるCI/CD（予定）
   - 統合テスト: ステージング環境での動作確認
   - ユーザー受け入れテスト: ステークホルダーによる検証

6. **本番デプロイ**
   - mainブランチへのマージ
   - 自動的に本番環境にデプロイ（予定）
   - デプロイ後確認: 本番環境での動作確認

#### 2.3.2 緊急修正時のフロー
1. **緊急度判定**
   - セキュリティ問題: 即座に対応
   - 重大なバグ: 24時間以内に対応
   - 軽微な問題: 通常フローで対応

2. **直接mainブランチでの修正**
   ```bash
   git checkout main
   git checkout -b hotfix/緊急修正内容
   # 修正実装
   git commit -m "hotfix: 緊急修正内容"
   git push origin hotfix/緊急修正内容
   ```

3. **緊急デプロイ**
   - 最小限のテストで本番デプロイ
   - 事後検証の実施

#### 2.3.3 ロールバック手順
1. **ロールバック判定**
   - 重大な問題の発生確認
   - 影響範囲の評価

2. **ロールバック実行**
   ```bash
   git checkout main
   git revert HEAD  # 直前のコミットを打ち消し
   git push origin main
   ```

3. **事後対応**
   - 問題の原因調査
   - 修正版の準備
   - 再デプロイ計画の策定

### 2.4 選定理由

#### 2.4.1 環境構成の選定理由
- **開発環境（Docker Compose）**: 
  - ローカル開発の高速化
  - 本番環境との一貫性確保
  - チーム開発での環境統一

- **ステージング環境（最小構成）**:
  - 本番前の最終検証
  - コスト最適化（最小構成）
  - 本番環境との差分検証

- **本番環境（本番構成）**:
  - 高可用性・高パフォーマンス
  - 自動スケーリング対応
  - 本番レベルの監視・ログ

#### 2.4.2 デプロイ方式の選定理由
- **現在の手動デプロイ**:
  - 開発段階での柔軟性確保
  - 段階的な自動化導入
  - 学習コストの最小化

- **将来のGitHub Actions自動化**:
  - CI/CDパイプラインの構築
  - テスト・ビルド・デプロイの自動化
  - 人的ミスの削減
  - デプロイ時間の短縮

#### 2.4.3 ブランチ戦略の選定理由
- **developブランチ → ステージング**:
  - 機能統合前の検証
  - 本番前の最終テスト
  - リリース候補の検証

- **mainブランチ → 本番**:
  - 安定版の本番リリース
  - 本番環境の安定性確保
  - ロールバックの容易性
=======
## 4. デプロイメントプロセス

### 4.1 開発フロー

#### 4.1.1 機能開発・修正の流れ
1. **フィーチャーブランチ作成**
   ```bash
   git checkout -b feature/機能名
   # または
   git checkout -b fix/修正内容
   ```

2. **ローカル開発・テスト**
   - フロントエンド: `npm run dev` でローカル開発
   - バックエンド: Docker Composeでローカル環境構築
   - 単体テスト実行: `npm test` / `pytest`
   - 手動テスト: ローカル環境での動作確認

3. **コードレビュー**
   - GitHub Pull Request作成
   - チームメンバーによるコードレビュー
   - レビュー指摘事項の修正

4. **developブランチへのマージ**
   - レビュー承認後、developブランチにマージ
   - 自動的にステージング環境にデプロイ

#### 4.1.2 ステージング環境での検証
- **自動テスト実行**: GitHub ActionsによるCI/CD
- **統合テスト**: ステージング環境での動作確認
- **ユーザー受け入れテスト**: ステークホルダーによる検証
- **パフォーマンステスト**: 負荷テストの実行

### 4.2 本番デプロイフロー

#### 4.2.1 リリース準備
1. **リリースノート作成**
   - 新機能・修正内容の文書化
   - 既知の問題・制限事項の記載

2. **最終検証**
   - ステージング環境での最終動作確認
   - セキュリティチェック
   - パフォーマンス確認

#### 4.2.2 本番デプロイ
1. **mainブランチへのマージ**
   ```bash
   git checkout main
   git merge develop
   git push origin main
   ```

2. **自動デプロイ実行**
   - GitHub Actionsが自動的に本番環境にデプロイ
   - フロントエンド: Vercelへの自動デプロイ
   - バックエンド: Cloud Runへの自動デプロイ

3. **デプロイ後確認**
   - 本番環境での動作確認
   - 監視システムでの正常性確認
   - ユーザーへの影響確認

### 4.3 緊急修正フロー

#### 4.3.1 ホットフィックス
1. **緊急度判定**
   - セキュリティ問題: 即座に対応
   - 重大なバグ: 24時間以内に対応
   - 軽微な問題: 通常フローで対応

2. **直接mainブランチでの修正**
   ```bash
   git checkout main
   git checkout -b hotfix/緊急修正内容
   # 修正実装
   git commit -m "hotfix: 緊急修正内容"
   git push origin hotfix/緊急修正内容
   ```

3. **緊急デプロイ**
   - 最小限のテストで本番デプロイ
   - 事後検証の実施

### 4.4 ロールバック手順

#### 4.4.1 自動ロールバック
- **ヘルスチェック失敗時**: 自動的に前バージョンにロールバック
- **エラー率閾値超過時**: 監視システムによる自動検知

#### 4.4.2 手動ロールバック
1. **ロールバック判定**
   - 重大な問題の発生確認
   - 影響範囲の評価

2. **ロールバック実行**
   ```bash
   git checkout main
   git revert HEAD  # 直前のコミットを打ち消し
   git push origin main
   ```

3. **事後対応**
   - 問題の原因調査
   - 修正版の準備
   - 再デプロイ計画の策定

### 4.5 デプロイメントチェックリスト

#### 4.5.1 デプロイ前チェック
- [ ] 全テストが通過している
- [ ] コードレビューが完了している
- [ ] セキュリティチェックが完了している
- [ ] パフォーマンステストが完了している
- [ ] データベースマイグレーションが準備されている
- [ ] 環境変数の更新が必要な場合は準備されている

#### 4.5.2 デプロイ後チェック
- [ ] アプリケーションが正常に起動している
- [ ] 主要機能が正常に動作している
- [ ] 監視システムでエラーが発生していない
- [ ] パフォーマンス指標が正常範囲内である
- [ ] ユーザーへの影響がないことを確認している

## 5. 運用管理

### 5.1 監視・ログ
- **Sentry**: エラー追跡（無料）
- **Vercel Analytics**: パフォーマンス監視
- **Cloud Monitoring**: インフラ監視

### 5.2 セキュリティ
- **環境変数**: GitHub Secretsで管理
- **アクセス制御**: 最小権限の原則
- **SSL/TLS**: 全通信の暗号化

### 5.3 バックアップ・復旧
- **データベース**: 自動バックアップ（日次、30日間保持）
- **アプリケーション**: ロールバック機能

## 6. 運用上の利点

### 6.1 サーバレス構成のメリット
- **運用負荷軽減**: サーバー管理不要、自動スケーリング
- **コスト最適化**: 使用量に応じた従量課金
- **高可用性**: マネージドサービスの冗長化

### 6.2 300円サブスクリプションモデルとの相性
- **初期コスト**: 月額¥2,400-4,300（最小構成）
- **本番コスト**: 月額¥6,400-15,800（本構成）
- **収益性**: 100人で月額¥30,000、運用コスト¥5,000-8,000で高い収益率
- **リスク軽減**: 従量課金で初期投資リスク最小化
>>>>>>> 5bab853 (docs: 機能追加や修正を行った際のデプロイまでのフローを明確にしました)
