# 運用設計書

## 目的

本ドキュメントは、感情教育アプリ『きもちみっけ！』の運用設計について定義する。システムの安定性、可用性、保守性を確保するため、適切な運用プロセスと監視体制を構築する。

## このドキュメントの使い方

運用方針や監視・メンテナンス手順を確認したい時に参照してください。本番環境の運用や障害対応に使用します。

## 1. 概要

### 1.2 対象システム
- フロントエンド: Next.js (TypeScript)
- バックエンド: FastAPI (Python)
- データベース: PostgreSQL
- ストレージ: AWS S3
- 音声処理: OpenAI Whisper

---

## 2. S3連携の運用設計

### 2.1 ファイル管理運用

#### 2.1.1 ファイル保存構造
```
s3://{bucket-name}/
├── audio/
│   └── {user_id}/
│       ├── audio_{YYYYMMDD}_{HHMMSS}_{unique_id}.wav
│       └── audio_{YYYYMMDD}_{HHMMSS}_{unique_id}.webm
├── text/
│   └── {user_id}/
│       └── text_{YYYYMMDD}_{HHMMSS}_{unique_id}.txt
└── images/
    └── emotions/
        ├── anshin.webp
        ├── kanashii.webp
        └── ...
```

#### 2.1.2 ファイル命名規則
- **音声ファイル**: `audio_{YYYYMMDD}_{HHMMSS}_{unique_id}.{extension}`
- **テキストファイル**: `text_{YYYYMMDD}_{HHMMSS}_{unique_id}.txt`
- **画像ファイル**: `{emotion_name}.webp`

#### 2.1.3 ファイルライフサイクル管理
- **保存期間**: 音声・テキストファイルは永続保存
- **バックアップ**: S3の自動バックアップ機能を活用
- **削除ポリシー**: ユーザー退会時の自動削除

### 2.2 アップロードフロー運用

#### 2.2.1 正常フロー
1. **Presigned URL取得**: フロントエンドがサーバーからURL取得
2. **直接アップロード**: フロントエンドがS3に直接アップロード
3. **処理開始**: アップロード完了後、音声処理を開始
4. **結果保存**: 処理結果をデータベースに保存

#### 2.2.2 エラーハンドリング
- **アップロード失敗**: リトライ機能（最大3回）
- **処理失敗**: エラーログ記録、管理者通知
- **部分失敗**: 部分的な結果を保存

### 2.3 ストレージ運用

#### 2.3.1 容量管理
- **監視項目**: バケット使用量、ファイル数
- **アラート**: 使用量80%超過時
- **最適化**: 定期的な不要ファイル削除

#### 2.3.2 コスト管理
- **監視項目**: S3使用料金、転送料金
- **最適化**: 
  - 適切なストレージクラス選択
  - 不要ファイルの早期削除
  - 圧縮による容量削減

---

## 3. データベース運用

### 3.1 バックアップ運用

#### 3.1.1 バックアップ戦略
- **頻度**: 日次フルバックアップ + 1時間間隔増分バックアップ
- **保持期間**: 30日間
- **検証**: 週次リストアテスト

#### 3.1.2 復旧手順
1. **障害検知**: 監視システムによる自動検知
2. **影響範囲確認**: 影響を受けるユーザー・機能の特定
3. **復旧実行**: 最新バックアップからの復旧
4. **動作確認**: 復旧後のシステム動作確認

### 3.2 パフォーマンス監視

#### 3.2.1 監視項目
- **クエリ実行時間**: 平均・95パーセンタイル
- **接続数**: アクティブ接続数、待機接続数
- **リソース使用率**: CPU、メモリ、ディスクI/O

#### 3.2.2 最適化施策
- **インデックス調整**: 実行計画に基づく最適化
- **クエリ改善**: 非効率なクエリの特定・修正
- **設定調整**: PostgreSQL設定パラメータの最適化

---

## 4. アプリケーション運用

### 4.1 デプロイメント運用

#### 4.1.1 デプロイ戦略
- **方式**: Blue-Green デプロイメント
- **ロールバック**: 問題発生時の即座なロールバック
- **テスト**: デプロイ前の自動テスト実行

#### 4.1.2 環境管理
- **開発環境**: 開発・テスト用
- **ステージング環境**: 本番前検証用
- **本番環境**: ユーザー向けサービス

### 4.2 監視・アラート

#### 4.2.1 システム監視
- **可用性**: サービス稼働率99.9%以上
- **レスポンス時間**: API平均500ms以下
- **エラー率**: 1%以下

#### 4.2.2 アラート設定
- **緊急**: サービス停止、データ損失
- **重要**: 性能劣化、エラー率上昇
- **情報**: 容量使用率、ログ量

---

## 5. セキュリティ運用

### 5.1 アクセス管理

#### 5.1.1 権限管理
- **最小権限の原則**: 必要最小限の権限のみ付与
- **定期的な権限見直し**: 四半期ごとの権限レビュー
- **アクセスログ監視**: 異常なアクセスパターンの検知

#### 5.1.2 認証・認可
- **多要素認証**: 管理者アカウントへのMFA適用
- **セッション管理**: 適切なセッションタイムアウト設定
- **API認証**: 適切なトークン管理

### 5.2 セキュリティ監視

#### 5.2.1 脅威検知
- **不正アクセス**: 異常なログイン試行の検知
- **データ漏洩**: 大量データアクセスの監視
- **マルウェア**: ファイルスキャンの実施

#### 5.2.2 インシデント対応
- **検知**: 自動検知システムによる早期発見
- **対応**: 標準化された対応手順の実行
- **復旧**: 影響範囲の最小化と迅速な復旧

---

## 6. ログ管理

### 6.1 ログ収集

#### 6.1.1 アプリケーションログ
- **レベル**: INFO, WARNING, ERROR, CRITICAL
- **内容**: リクエスト、レスポンス、エラー詳細
- **保持期間**: 90日間

#### 6.1.2 システムログ
- **OSログ**: システムイベント、セキュリティイベント
- **ミドルウェアログ**: Webサーバー、データベースログ
- **保持期間**: 180日間

### 6.2 ログ分析

#### 6.2.1 分析項目
- **エラー分析**: エラーパターンの特定・分析
- **性能分析**: レスポンス時間の傾向分析
- **セキュリティ分析**: 不正アクセスの検知

#### 6.2.2 レポート作成
- **日次レポート**: システム稼働状況
- **週次レポート**: 性能・セキュリティ状況
- **月次レポート**: 運用改善提案

---

## 7. 障害対応

### 7.1 障害レベル定義

#### 7.1.1 レベル1（緊急）
- **定義**: サービス完全停止、データ損失
- **対応時間**: 30分以内
- **対応者**: オンコール担当者

#### 7.1.2 レベル2（重要）
- **定義**: 機能一部停止、性能劣化
- **対応時間**: 2時間以内
- **対応者**: 開発チーム

#### 7.1.3 レベル3（軽微）
- **定義**: 機能制限、表示異常
- **対応時間**: 24時間以内
- **対応者**: 通常業務内

### 7.2 障害対応手順

#### 7.2.1 初動対応
1. **状況確認**: 影響範囲・程度の把握
2. **一次対応**: 応急処置の実施
3. **関係者連絡**: ステークホルダーへの通知
4. **調査開始**: 原因調査の開始

#### 7.2.2 復旧作業
1. **原因特定**: 根本原因の特定
2. **復旧作業**: システム復旧の実行
3. **動作確認**: 復旧後の動作確認
4. **事後対応**: 再発防止策の検討

---

## 8. 運用改善

### 8.1 定期的な見直し

#### 8.1.1 月次レビュー
- **性能指標**: レスポンス時間、エラー率の確認
- **セキュリティ**: セキュリティイベントの分析
- **改善提案**: 運用改善案の検討

#### 8.1.2 四半期レビュー
- **運用効率**: 運用プロセスの効率化
- **コスト最適化**: 運用コストの見直し
- **技術更新**: 新技術の導入検討

### 8.2 継続的改善

#### 8.2.1 自動化推進
- **デプロイ自動化**: CI/CDパイプラインの改善
- **監視自動化**: 監視・アラートの自動化
- **運用自動化**: 日常作業の自動化

#### 8.2.2 ドキュメント更新
- **運用手順書**: 定期的な更新・改善
- **障害対応手順**: 新しい障害パターンの追加
- **ベストプラクティス**: 運用ノウハウの蓄積
