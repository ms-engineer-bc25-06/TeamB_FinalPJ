# âš¡ï¸ Backend ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— (FastAPI + PostgreSQL)

ã“ã® README ã§ã¯ `backend` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§å¿…è¦ãªã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †ã‚’ã¾ã¨ã‚ã¦ã„ã¾ã™ã€‚

## ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```
backend/
â”œâ”€â”€ app/                        # ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py                # FastAPI ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ models.py              # SQLAlchemy ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«
â”‚   â”œâ”€â”€ schemas.py             # Pydantic ãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚­ãƒ¼ãƒ
â”‚   â”œâ”€â”€ crud.py                # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œé–¢æ•°
â”‚   â”œâ”€â”€ database.py            # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šè¨­å®š
â”‚   â”œâ”€â”€ children.py            # å­ä¾›æƒ…å ±ç®¡ç†
â”‚   â”œâ”€â”€ emotion_api.py         # æ„Ÿæƒ…API
â”‚   â”œâ”€â”€ emotion_color_api.py   # æ„Ÿæƒ…è‰²API
â”‚   â”œâ”€â”€ emotion_logs_service.py # æ„Ÿæƒ…ãƒ­ã‚°ã‚µãƒ¼ãƒ“ã‚¹
â”‚   â”œâ”€â”€ stripe_api.py          # Stripeæ±ºæ¸ˆAPI
â”‚   â”œâ”€â”€ api/                   # APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
â”‚   â”‚   â””â”€â”€ v1/
â”‚   â”‚       â””â”€â”€ endpoints/
â”‚   â”‚           â””â”€â”€ voice.py   # éŸ³å£°é–¢é€£API
â”‚   â”œâ”€â”€ services/              # ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
â”‚   â”‚   â”œâ”€â”€ emotion_logs/      # æ„Ÿæƒ…ãƒ­ã‚°ã‚µãƒ¼ãƒ“ã‚¹
â”‚   â”‚   â”œâ”€â”€ s3.py              # S3ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ voice/             # éŸ³å£°å‡¦ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ file_ops.py    # ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œ
â”‚   â”‚   â”‚   â””â”€â”€ transcription.py # éŸ³å£°æ–‡å­—èµ·ã“ã—
â”‚   â”‚   â””â”€â”€ whisper.py         # WhisperéŸ³å£°èªè­˜
â”‚   â”œâ”€â”€ utils/                  # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚   â”‚   â”œâ”€â”€ audio.py           # éŸ³å£°å‡¦ç†ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚   â”‚   â”œâ”€â”€ constants.py       # å®šæ•°å®šç¾©
â”‚   â”‚   â”œâ”€â”€ error_handlers.py  # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
â”‚   â”‚   â”œâ”€â”€ prompt_loader.py   # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª­ã¿è¾¼ã¿
â”‚   â”‚   â””â”€â”€ quality.py         # å“è³ªç®¡ç†
â”‚   â””â”€â”€ config/                 # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
â”‚       â””â”€â”€ prompt_base.txt    # åŸºæœ¬ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
â”œâ”€â”€ migrations/                 # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â””â”€â”€ versions/              # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ tests/                      # ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«
â”‚   â”œâ”€â”€ unit/                  # ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
â”‚   â””â”€â”€ integration/           # çµ±åˆãƒ†ã‚¹ãƒˆ
â”œâ”€â”€ alembic.ini                # Alembicè¨­å®š
â”œâ”€â”€ requirements.txt            # æœ¬ç•ªä¾å­˜é–¢ä¿‚
â”œâ”€â”€ requirements-dev.txt        # é–‹ç™ºä¾å­˜é–¢ä¿‚
â”œâ”€â”€ Dockerfile                  # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸å®šç¾©
â”œâ”€â”€ compose.yaml                # Docker Composeè¨­å®š
â””â”€â”€ wait-for-db.sh             # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹èµ·å‹•å¾…æ©Ÿã‚¹ã‚¯ãƒªãƒ—ãƒˆ
```

## 1. Firebase ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ã®é…ç½®

- Notion ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸ JSON ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ `backend/firebase-service-account.json` ã«é…ç½®

## 2. ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«è¨­å®š

- `.env.example` ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ `.env` ã‚’ä½œæˆ
- Postgres ã‚„ Stripe Webhook ãªã©ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š

## 3. å¾…æ©Ÿã‚¹ã‚¯ãƒªãƒ—ãƒˆã«å®Ÿè¡Œæ¨©é™ä»˜ä¸ï¼ˆåˆå›ã®ã¿ï¼‰

```bash
chmod +x wait-for-db.sh
```

## 4. Docker ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•

```bash
docker compose up --build -d
```

## 5. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨ï¼ˆåˆå› or ãƒ¢ãƒ‡ãƒ«æ›´æ–°æ™‚ï¼‰

```bash
docker compose exec backend alembic upgrade head
docker compose exec backend alembic current
```

## 6. DevContainer ä½¿ç”¨æ™‚ï¼ˆæ¨å¥¨ï¼‰

`.devcontainer/devcontainer.json` ã«ã‚ˆã‚Šè‡ªå‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### DevContainer ã®åˆ©ç‚¹
- ãƒãƒ¼ãƒ å…¨ä½“ã§å…±é€šã®é–‹ç™ºç’°å¢ƒï¼ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã€ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ãªã©ï¼‰
- ä¿å­˜æ™‚æ•´å½¢ã‚„ import æ•´ç†ãªã©ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¾å­˜ã›ãšå®Ÿè¡Œ
- åˆå›èµ·å‹•æ™‚ã«è‡ªå‹•ã§ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã‚‹ï¼š
  ```bash
  pip install -r requirements-dev.txt
  ```

### VSCode ã§ã®è‡ªå‹•è¨­å®š
- ä¿å­˜æ™‚ã«è‡ªå‹•ã§ `black` ã«ã‚ˆã‚‹æ•´å½¢ãŒå®Ÿè¡Œã•ã‚Œã‚‹
- `pylint` ã«ã‚ˆã‚‹ Lint ãŒæœ‰åŠ¹ã«ãªã‚‹

### åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †
1. VSCode æ‹¡å¼µã€ŒDev Containersã€ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ VSCode ã§é–‹ã
3. å·¦ä¸‹ã®ç·‘è‰²ã®ãƒœã‚¿ãƒ³ ğŸŸ¢ ã‹ã‚‰ã€ŒReopen in Containerã€ã‚’é¸æŠ
4. è‡ªå‹•çš„ã«ã‚³ãƒ³ãƒ†ãƒŠãŒãƒ“ãƒ«ãƒ‰ã•ã‚Œã€é–‹ç™ºç’°å¢ƒãŒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã•ã‚Œã‚‹

> ğŸ’¡ åˆå›ãƒ“ãƒ«ãƒ‰ã«ã¯ 5ã€œ10 åˆ†ã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚2 å›ç›®ä»¥é™ã¯é«˜é€Ÿã«èµ·å‹•ã—ã¾ã™ã€‚

## 7. DevContainer æœªä½¿ç”¨æ™‚

```bash
docker compose exec backend pip install -r requirements-dev.txt
docker compose exec backend black app
docker compose exec backend pylint app
```

## 8. Stripe Webhook è¨­å®š

```bash
stripe listen --forward-to localhost:8000/api/v1/stripe/webhook
```

## 9. å‹•ä½œç¢ºèª

- `docker compose ps` ã§ã‚³ãƒ³ãƒ†ãƒŠã®çŠ¶æ…‹ç¢ºèª
- ãƒ–ãƒ©ã‚¦ã‚¶ã§ http://localhost:8000/docs ã‚’é–‹ã Swagger UI ã§ API ã‚’ãƒ†ã‚¹ãƒˆ

## 10. æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯è©³ç´°

### ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãƒ»ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- **FastAPI**: 0.111.0
- **Uvicorn**: 0.35.0 (ASGIã‚µãƒ¼ãƒãƒ¼)
- **SQLAlchemy**: 2.0.42 (ORM)
- **Pydantic**: 2.7.4 (ãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³)
- **PostgreSQL**: 17.5-alpine (ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹)

### AIãƒ»éŸ³å£°å‡¦ç†
- **OpenAI Whisper**: 20231117 (éŸ³å£°èªè­˜)
- **PyTorch**: 2.1.0 (CPUç‰ˆ)
- **FFmpeg**: éŸ³å£°å‡¦ç†
- **Pydub**: 0.25.1 (éŸ³å£°æ“ä½œ)

### å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹é€£æº
- **Firebase Admin**: 7.1.0 (èªè¨¼)
- **AWS S3 (boto3)**: 1.34.0 (ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸)
- **Stripe**: 12.4.0 (æ±ºæ¸ˆ)

## 11. é–‹ç™ºç’°å¢ƒ

- **Python**: 3.11-slim
- **PostgreSQL**: 17.5-alpine
- **Docker**: ã‚³ãƒ³ãƒ†ãƒŠåŒ–ç’°å¢ƒ

## 12. åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰

```bash
# ã‚³ãƒ³ãƒ†ãƒŠç®¡ç†
docker compose up --build -d    # ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•
docker compose down             # ã‚³ãƒ³ãƒ†ãƒŠåœæ­¢
docker compose ps               # çŠ¶æ…‹ç¢ºèª
docker compose logs backend     # ãƒ­ã‚°ç¢ºèª

# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æ“ä½œ
docker compose exec backend bash           # ã‚³ãƒ³ãƒ†ãƒŠå†…ã§bashå®Ÿè¡Œ
docker compose exec backend python -m pytest  # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
docker compose exec backend alembic upgrade head  # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
```

## 13. å†ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå¿…è¦ãªã‚±ãƒ¼ã‚¹

| ã‚±ãƒ¼ã‚¹ | å†ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å¿…è¦ï¼Ÿ | ç†ç”± |
| ------ | -------------------- | ---- |
| `--build`ä»˜ãã§ `docker compose up --build` ã‚’å®Ÿè¡Œã—ãŸå ´åˆ | âœ… **å¿…è¦** | ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒå†ç”Ÿæˆã•ã‚Œã‚‹ãŸã‚ã€é–‹ç™ºãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒæ¶ˆãˆã‚‹ï¼ˆ`black`, `pylint`ãªã©ï¼‰ |
| ã‚³ãƒ³ãƒ†ãƒŠã‚„ volume ã‚’å‰Šé™¤ã—ãŸ (`docker compose down -v`) | âœ… **å¿…è¦** | volume ã”ã¨å‰Šé™¤ã•ã‚Œã‚‹ãŸã‚ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå¤±ã‚ã‚Œã‚‹ |
| `.devcontainer/devcontainer.json` ã® `postCreateCommand` ãŒä½•ã‚‰ã‹ã®ç†ç”±ã§å®Ÿè¡Œã•ã‚Œãªã‹ã£ãŸ | âœ… **å¿…è¦** | ã‚³ãƒãƒ³ãƒ‰ãŒå¤±æ•—ã™ã‚‹ã¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå…¥ã£ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚‹ |
| VSCode ã® DevContainer å†æ§‹ç¯‰æ™‚ã« `Rebuild Container` ã‚’é¸æŠ | âœ… **å¿…è¦** | ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‹ã‚‰å†æ§‹ç¯‰ã•ã‚Œã‚‹ãŸã‚é–‹ç™ºãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒæœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« |

### å†ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå¿…è¦ã‹ã©ã†ã‹ã®ç¢ºèªæ–¹æ³•

```bash
docker compose exec backend which black
```

- ãƒ‘ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã‚Œã° OKï¼ˆä¾‹ï¼š `/usr/local/bin/black`ï¼‰
- è¡¨ç¤ºã•ã‚Œãªã‘ã‚Œã°å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå¿…è¦ï¼š
  ```bash
  docker compose exec backend pip install -r requirements-dev.txt
  ```

## 14. S3 é€£æºã®è©³ç´°

### æ¦‚è¦
- éŸ³å£°ãƒ»ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¯ S3 ã«ä¿å­˜
- S3 ã¸ã®ãƒ‘ã‚¹ã¯ DB ã«ä¿å­˜
- ã‚µãƒ¼ãƒãƒ¼ã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿æŒã—ãªã„æ§‹æˆ
- **å¯¾å¿œå½¢å¼**: WebM, WAV, MP3 (éŸ³å£°), TXT (ãƒ†ã‚­ã‚¹ãƒˆ)
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: Presigned URL ã«ã‚ˆã‚‹å®‰å…¨ãªã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
- **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**: S3 ç›´æ¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«ã‚ˆã‚‹ã‚µãƒ¼ãƒãƒ¼è² è·è»½æ¸›

### API ãƒ†ã‚¹ãƒˆæ–¹æ³•

#### curl ã§ã®ãƒ†ã‚¹ãƒˆ

```bash
# URLå–å¾—
curl -X POST http://localhost:8000/voice/get-upload-url \
  -H "Content-Type: application/json" \
  -d '{"user_id":1,"file_type":"audio","file_format":"webm"}'

# ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
curl -X PUT "<upload_url>" \
  -H "Content-Type: audio/webm" \
  --data-binary "@path/to/file.webm"
```

âš ï¸ Content-Type ã‚’å¿˜ã‚Œã‚‹ã¨å¤±æ•—ã™ã‚‹ã®ã§æ³¨æ„ï¼
